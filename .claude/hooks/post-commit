#!/bin/bash

# CMIS Auto-Update Knowledge Hook
# This hook runs after each commit to automatically update knowledge maps
# based on which files were changed in the commit.

# Detect which files changed in the last commit
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD 2>/dev/null)

# Exit if no files changed (shouldn't happen, but just in case)
if [ -z "$CHANGED_FILES" ]; then
    exit 0
fi

# Track if we need to update any knowledge
NEED_UPDATE=false
UPDATED_FILES=""

# Check if docs changed (PRIMARY SOURCE - check first!)
if echo "$CHANGED_FILES" | grep -q "docs/"; then
    echo "üìö Documentation changed, updating docs index..."
    php artisan knowledge:generate-docs-index > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        NEED_UPDATE=true
        UPDATED_FILES="${UPDATED_FILES}\n- DOCS_INDEX.md"
    fi
fi

# Check if models changed
if echo "$CHANGED_FILES" | grep -q "app/Models"; then
    echo "üì¶ Models changed, updating model relationship graph..."
    php artisan knowledge:generate-model-graph > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        NEED_UPDATE=true
        UPDATED_FILES="${UPDATED_FILES}\n- MODEL_RELATIONSHIP_GRAPH.md"
    fi
fi

# Check if services changed
if echo "$CHANGED_FILES" | grep -q "app/Services"; then
    echo "‚öôÔ∏è  Services changed, updating service layer map..."
    php artisan knowledge:generate-service-map > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        NEED_UPDATE=true
        UPDATED_FILES="${UPDATED_FILES}\n- SERVICE_LAYER_MAP.md"
    fi
fi

# Check if controllers changed
if echo "$CHANGED_FILES" | grep -q "app/Http/Controllers"; then
    echo "üéÆ Controllers changed, updating codebase map..."
    php artisan knowledge:generate-codebase-map > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        NEED_UPDATE=true
        UPDATED_FILES="${UPDATED_FILES}\n- CODEBASE_MAP.md"
    fi
fi

# Check if migrations changed
if echo "$CHANGED_FILES" | grep -q "database/migrations"; then
    echo "üóÑÔ∏è  Migrations changed, updating schema map..."
    php artisan knowledge:generate-schema-map > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        NEED_UPDATE=true
        UPDATED_FILES="${UPDATED_FILES}\n- DATABASE_SCHEMA_MAP.md"
    fi
fi

# Check if repositories changed
if echo "$CHANGED_FILES" | grep -q "app/Repositories"; then
    echo "üìö Repositories changed, updating service layer map..."
    php artisan knowledge:generate-service-map > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        NEED_UPDATE=true
        UPDATED_FILES="${UPDATED_FILES}\n- SERVICE_LAYER_MAP.md"
    fi
fi

# If any knowledge was updated, auto-commit it
if [ "$NEED_UPDATE" = true ]; then
    # Check if there are changes to commit
    if ! git diff --quiet .claude/knowledge/auto-generated/ 2>/dev/null; then
        echo ""
        echo "üìù Auto-committing updated knowledge files..."
        git add .claude/knowledge/auto-generated/ 2>/dev/null

        # Create commit message
        COMMIT_MSG="chore: auto-update knowledge maps [skip ci]

Updated knowledge files:${UPDATED_FILES}

Generated by: cmis-knowledge-maintainer agent
Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
Triggered by: post-commit hook"

        git commit --no-verify -m "$COMMIT_MSG" 2>/dev/null

        if [ $? -eq 0 ]; then
            echo "‚úÖ Knowledge maps updated and committed"
        else
            echo "‚ö†Ô∏è  Failed to commit knowledge updates (may already be committed)"
        fi
    else
        echo "‚úÖ Knowledge maps updated (no changes to commit)"
    fi
fi

exit 0
