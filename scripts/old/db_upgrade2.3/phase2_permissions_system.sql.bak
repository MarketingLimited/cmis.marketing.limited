-- ================================================================
-- CMIS Database Fix Script - Phase 2: Advanced Permissions System
-- المرحلة الثانية: نظام الصلاحيات المتقدم
-- ================================================================
-- تاريخ: 2025-11-11
-- الهدف: تطبيق نظام صلاحيات متقدم يدعم تعدد المستخدمين والشركات
-- ================================================================

BEGIN;

-- ================================================================
-- 1. إنشاء جداول نظام الصلاحيات المتقدم
-- ================================================================

-- جدول العلاقة بين المستخدمين والشركات (many-to-many)
CREATE TABLE IF NOT EXISTS cmis.user_orgs (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES cmis.users(user_id) ON DELETE CASCADE,
    org_id uuid NOT NULL REFERENCES cmis.orgs(org_id) ON DELETE CASCADE,
    role_id uuid NOT NULL, -- سيتم ربطه بجدول الأدوار
    is_active boolean DEFAULT true,
    joined_at timestamptz DEFAULT CURRENT_TIMESTAMP,
    invited_by uuid REFERENCES cmis.users(user_id),
    last_accessed timestamptz,
    UNIQUE(user_id, org_id)
);

-- جدول الأدوار
CREATE TABLE IF NOT EXISTS cmis.roles (
    role_id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    org_id uuid REFERENCES cmis.orgs(org_id) ON DELETE CASCADE,
    role_name text NOT NULL,
    role_code text NOT NULL,
    description text,
    is_system boolean DEFAULT false, -- أدوار النظام الافتراضية
    is_active boolean DEFAULT true,
    created_at timestamptz DEFAULT CURRENT_TIMESTAMP,
    created_by uuid REFERENCES cmis.users(user_id),
    UNIQUE(org_id, role_code)
);

-- جدول الصلاحيات
CREATE TABLE IF NOT EXISTS cmis.permissions (
    permission_id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    permission_code text UNIQUE NOT NULL,
    permission_name text NOT NULL,
    category text NOT NULL, -- campaigns, creatives, analytics, admin, etc.
    description text,
    is_dangerous boolean DEFAULT false -- صلاحيات حساسة
);

-- جدول ربط الأدوار بالصلاحيات
CREATE TABLE IF NOT EXISTS cmis.role_permissions (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    role_id uuid NOT NULL REFERENCES cmis.roles(role_id) ON DELETE CASCADE,
    permission_id uuid NOT NULL REFERENCES cmis.permissions(permission_id) ON DELETE CASCADE,
    granted_at timestamptz DEFAULT CURRENT_TIMESTAMP,
    granted_by uuid REFERENCES cmis.users(user_id),
    UNIQUE(role_id, permission_id)
);

-- جدول الصلاحيات المباشرة للمستخدمين (تجاوز الأدوار)
CREATE TABLE IF NOT EXISTS cmis.user_permissions (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES cmis.users(user_id) ON DELETE CASCADE,
    org_id uuid NOT NULL REFERENCES cmis.orgs(org_id) ON DELETE CASCADE,
    permission_id uuid NOT NULL REFERENCES cmis.permissions(permission_id) ON DELETE CASCADE,
    is_granted boolean DEFAULT true, -- true للمنح، false للمنع
    granted_at timestamptz DEFAULT CURRENT_TIMESTAMP,
    granted_by uuid REFERENCES cmis.users(user_id),
    expires_at timestamptz, -- صلاحيات مؤقتة
    UNIQUE(user_id, org_id, permission_id)
);

-- جدول سجل نشاطات المستخدمين
CREATE TABLE IF NOT EXISTS cmis.user_activities (
    activity_id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES cmis.users(user_id),
    org_id uuid NOT NULL REFERENCES cmis.orgs(org_id),
    session_id uuid REFERENCES cmis.user_sessions(session_id),
    action text NOT NULL,
    entity_type text,
    entity_id uuid,
    details jsonb,
    ip_address inet,
    created_at timestamptz DEFAULT CURRENT_TIMESTAMP
);

-- إضافة FK للأدوار في user_orgs
ALTER TABLE cmis.user_orgs 
ADD CONSTRAINT fk_user_orgs_role 
FOREIGN KEY (role_id) REFERENCES cmis.roles(role_id);

-- ================================================================
-- 2. ترحيل البيانات الموجودة
-- ================================================================

-- إنشاء الأدوار الافتراضية لكل شركة
INSERT INTO cmis.roles (org_id, role_name, role_code, description, is_system)
SELECT DISTINCT 
    org_id,
    'مدير النظام',
    'admin',
    'صلاحيات كاملة على النظام',
    true
FROM cmis.orgs
ON CONFLICT (org_id, role_code) DO NOTHING;

INSERT INTO cmis.roles (org_id, role_name, role_code, description, is_system)
SELECT DISTINCT 
    org_id,
    'محرر',
    'editor',
    'إنشاء وتعديل المحتوى',
    true
FROM cmis.orgs
ON CONFLICT (org_id, role_code) DO NOTHING;

INSERT INTO cmis.roles (org_id, role_name, role_code, description, is_system)
SELECT DISTINCT 
    org_id,
    'مشاهد',
    'viewer',
    'عرض المحتوى فقط',
    true
FROM cmis.orgs
ON CONFLICT (org_id, role_code) DO NOTHING;

-- ترحيل المستخدمين الحاليين إلى النظام الجديد
INSERT INTO cmis.user_orgs (user_id, org_id, role_id)
SELECT 
    u.user_id,
    u.org_id,
    r.role_id
FROM cmis.users u
JOIN cmis.roles r ON r.org_id = u.org_id AND r.role_code = u.role
ON CONFLICT (user_id, org_id) DO NOTHING;

-- ================================================================
-- 3. إضافة الصلاحيات الأساسية
-- ================================================================

-- صلاحيات الحملات
INSERT INTO cmis.permissions (permission_code, permission_name, category, description) VALUES
('campaigns.view', 'عرض الحملات', 'campaigns', 'عرض قائمة الحملات وتفاصيلها'),
('campaigns.create', 'إنشاء حملات', 'campaigns', 'إنشاء حملات جديدة'),
('campaigns.edit', 'تعديل حملات', 'campaigns', 'تعديل الحملات الموجودة'),
('campaigns.delete', 'حذف حملات', 'campaigns', 'حذف الحملات', true),
('campaigns.publish', 'نشر حملات', 'campaigns', 'نشر الحملات للجمهور');

-- صلاحيات المحتوى الإبداعي
INSERT INTO cmis.permissions (permission_code, permission_name, category, description) VALUES
('creatives.view', 'عرض المحتوى الإبداعي', 'creatives', 'عرض المحتوى الإبداعي'),
('creatives.create', 'إنشاء محتوى إبداعي', 'creatives', 'إنشاء محتوى إبداعي جديد'),
('creatives.edit', 'تعديل محتوى إبداعي', 'creatives', 'تعديل المحتوى الإبداعي'),
('creatives.delete', 'حذف محتوى إبداعي', 'creatives', 'حذف المحتوى الإبداعي', true),
('creatives.approve', 'اعتماد محتوى إبداعي', 'creatives', 'اعتماد المحتوى للنشر');

-- صلاحيات التحليلات
INSERT INTO cmis.permissions (permission_code, permission_name, category, description) VALUES
('analytics.view', 'عرض التحليلات', 'analytics', 'عرض التقارير والتحليلات'),
('analytics.export', 'تصدير التحليلات', 'analytics', 'تصدير التقارير'),
('analytics.configure', 'إعداد التحليلات', 'analytics', 'تغيير إعدادات التحليلات');

-- صلاحيات الإدارة
INSERT INTO cmis.permissions (permission_code, permission_name, category, description) VALUES
('admin.users', 'إدارة المستخدمين', 'admin', 'إضافة وتعديل المستخدمين', true),
('admin.roles', 'إدارة الأدوار', 'admin', 'إنشاء وتعديل الأدوار', true),
('admin.settings', 'إدارة الإعدادات', 'admin', 'تغيير إعدادات النظام', true),
('admin.integrations', 'إدارة التكاملات', 'admin', 'إدارة التكاملات الخارجية', true);

-- ================================================================
-- 4. ربط الصلاحيات بالأدوار الافتراضية
-- ================================================================

-- Admin = كل الصلاحيات
INSERT INTO cmis.role_permissions (role_id, permission_id)
SELECT r.role_id, p.permission_id
FROM cmis.roles r
CROSS JOIN cmis.permissions p
WHERE r.role_code = 'admin'
ON CONFLICT (role_id, permission_id) DO NOTHING;

-- Editor = كل شيء عدا الإدارة والحذف
INSERT INTO cmis.role_permissions (role_id, permission_id)
SELECT r.role_id, p.permission_id
FROM cmis.roles r
CROSS JOIN cmis.permissions p
WHERE r.role_code = 'editor'
  AND p.permission_code NOT LIKE 'admin.%'
  AND p.permission_code NOT LIKE '%.delete'
ON CONFLICT (role_id, permission_id) DO NOTHING;

-- Viewer = عرض فقط
INSERT INTO cmis.role_permissions (role_id, permission_id)
SELECT r.role_id, p.permission_id
FROM cmis.roles r
CROSS JOIN cmis.permissions p
WHERE r.role_code = 'viewer'
  AND p.permission_code LIKE '%.view'
ON CONFLICT (role_id, permission_id) DO NOTHING;

-- ================================================================
-- 5. دوال مساعدة للتحقق من الصلاحيات
-- ================================================================

-- دالة للتحقق من صلاحية المستخدم
CREATE OR REPLACE FUNCTION cmis.check_permission(
    p_user_id uuid,
    p_org_id uuid,
    p_permission_code text
) RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_has_permission boolean := false;
BEGIN
    -- التحقق من الصلاحيات المباشرة أولاً
    SELECT EXISTS (
        SELECT 1 
        FROM cmis.user_permissions up
        JOIN cmis.permissions p ON p.permission_id = up.permission_id
        WHERE up.user_id = p_user_id
          AND up.org_id = p_org_id
          AND p.permission_code = p_permission_code
          AND up.is_granted = true
          AND (up.expires_at IS NULL OR up.expires_at > CURRENT_TIMESTAMP)
    ) INTO v_has_permission;
    
    IF v_has_permission THEN
        RETURN true;
    END IF;
    
    -- التحقق من صلاحيات الدور
    SELECT EXISTS (
        SELECT 1
        FROM cmis.user_orgs uo
        JOIN cmis.role_permissions rp ON rp.role_id = uo.role_id
        JOIN cmis.permissions p ON p.permission_id = rp.permission_id
        WHERE uo.user_id = p_user_id
          AND uo.org_id = p_org_id
          AND uo.is_active = true
          AND p.permission_code = p_permission_code
    ) INTO v_has_permission;
    
    -- التحقق من المنع المباشر (override)
    IF v_has_permission THEN
        SELECT NOT EXISTS (
            SELECT 1 
            FROM cmis.user_permissions up
            JOIN cmis.permissions p ON p.permission_id = up.permission_id
            WHERE up.user_id = p_user_id
              AND up.org_id = p_org_id
              AND p.permission_code = p_permission_code
              AND up.is_granted = false
        ) INTO v_has_permission;
    END IF;
    
    RETURN v_has_permission;
END;
$$;

-- دالة للحصول على كل صلاحيات المستخدم
CREATE OR REPLACE FUNCTION cmis.get_user_permissions(
    p_user_id uuid,
    p_org_id uuid
) RETURNS TABLE (
    permission_code text,
    permission_name text,
    category text,
    source text -- 'role' أو 'direct'
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    -- صلاحيات الأدوار
    SELECT DISTINCT
        p.permission_code,
        p.permission_name,
        p.category,
        'role'::text as source
    FROM cmis.user_orgs uo
    JOIN cmis.role_permissions rp ON rp.role_id = uo.role_id
    JOIN cmis.permissions p ON p.permission_id = rp.permission_id
    WHERE uo.user_id = p_user_id
      AND uo.org_id = p_org_id
      AND uo.is_active = true
    
    UNION
    
    -- الصلاحيات المباشرة (الممنوحة)
    SELECT 
        p.permission_code,
        p.permission_name,
        p.category,
        'direct'::text as source
    FROM cmis.user_permissions up
    JOIN cmis.permissions p ON p.permission_id = up.permission_id
    WHERE up.user_id = p_user_id
      AND up.org_id = p_org_id
      AND up.is_granted = true
      AND (up.expires_at IS NULL OR up.expires_at > CURRENT_TIMESTAMP)
    
    EXCEPT
    
    -- استبعاد الصلاحيات المحظورة مباشرة
    SELECT 
        p.permission_code,
        p.permission_name,
        p.category,
        'denied'::text as source
    FROM cmis.user_permissions up
    JOIN cmis.permissions p ON p.permission_id = up.permission_id
    WHERE up.user_id = p_user_id
      AND up.org_id = p_org_id
      AND up.is_granted = false;
END;
$$;

-- دالة للحصول على شركات المستخدم
CREATE OR REPLACE FUNCTION cmis.get_user_orgs(p_user_id uuid)
RETURNS TABLE (
    org_id uuid,
    org_name text,
    role_name text,
    role_code text,
    joined_at timestamptz,
    last_accessed timestamptz
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        o.org_id,
        o.name::text,
        r.role_name,
        r.role_code,
        uo.joined_at,
        uo.last_accessed
    FROM cmis.user_orgs uo
    JOIN cmis.orgs o ON o.org_id = uo.org_id
    JOIN cmis.roles r ON r.role_id = uo.role_id
    WHERE uo.user_id = p_user_id
      AND uo.is_active = true
    ORDER BY uo.last_accessed DESC NULLS LAST;
END;
$$;

-- ================================================================
-- 6. تحديث دوال RLS
-- ================================================================

-- دالة محسنة للحصول على الشركة النشطة
CREATE OR REPLACE FUNCTION cmis.get_current_org_id()
RETURNS uuid
LANGUAGE plpgsql
AS $$
DECLARE
    v_session_token text;
    v_org_id uuid;
BEGIN
    -- محاولة الحصول من إعداد الجلسة
    BEGIN
        v_org_id := current_setting('app.current_org_id')::uuid;
        IF v_org_id IS NOT NULL THEN
            RETURN v_org_id;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- محاولة الحصول من token الجلسة
    BEGIN
        v_session_token := current_setting('app.session_token');
        
        SELECT sc.active_org_id INTO v_org_id
        FROM cmis.user_sessions us
        JOIN cmis.session_context sc ON sc.session_id = us.session_id
        WHERE us.session_token = v_session_token
          AND us.is_active = true
          AND us.expires_at > CURRENT_TIMESTAMP;
        
        IF v_org_id IS NOT NULL THEN
            RETURN v_org_id;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    RETURN NULL;
END;
$$;

-- دالة للحصول على المستخدم الحالي
CREATE OR REPLACE FUNCTION cmis.get_current_user_id()
RETURNS uuid
LANGUAGE plpgsql
AS $$
DECLARE
    v_session_token text;
    v_user_id uuid;
BEGIN
    -- محاولة الحصول من إعداد الجلسة
    BEGIN
        v_user_id := current_setting('app.current_user_id')::uuid;
        IF v_user_id IS NOT NULL THEN
            RETURN v_user_id;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- محاولة الحصول من token الجلسة
    BEGIN
        v_session_token := current_setting('app.session_token');
        
        SELECT us.user_id INTO v_user_id
        FROM cmis.user_sessions us
        WHERE us.session_token = v_session_token
          AND us.is_active = true
          AND us.expires_at > CURRENT_TIMESTAMP;
        
        IF v_user_id IS NOT NULL THEN
            RETURN v_user_id;
        END IF;
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    RETURN NULL;
END;
$$;

-- ================================================================
-- 7. تحديث سياسات RLS
-- ================================================================

-- تفعيل RLS على الجداول الجديدة
ALTER TABLE cmis.user_orgs ENABLE ROW LEVEL SECURITY;
ALTER TABLE cmis.roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE cmis.role_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE cmis.user_permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE cmis.user_activities ENABLE ROW LEVEL SECURITY;

-- سياسات للجداول الجديدة

-- user_orgs: المستخدم يرى علاقاته فقط
CREATE POLICY user_orgs_self ON cmis.user_orgs
    FOR SELECT
    USING (user_id = cmis.get_current_user_id());

-- الأدمن يرى كل المستخدمين في شركته
CREATE POLICY user_orgs_admin ON cmis.user_orgs
    FOR ALL
    USING (
        org_id = cmis.get_current_org_id() 
        AND cmis.check_permission(cmis.get_current_user_id(), cmis.get_current_org_id(), 'admin.users')
    );

-- roles: الكل يرى الأدوار في شركته
CREATE POLICY roles_org ON cmis.roles
    FOR SELECT
    USING (org_id = cmis.get_current_org_id() OR org_id IS NULL);

-- الأدمن فقط يعدل الأدوار
CREATE POLICY roles_admin ON cmis.roles
    FOR ALL
    USING (
        cmis.check_permission(cmis.get_current_user_id(), cmis.get_current_org_id(), 'admin.roles')
    );

-- تحديث السياسات الموجودة
DROP POLICY IF EXISTS org_isolation_campaigns ON cmis.campaigns;
CREATE POLICY org_isolation_campaigns ON cmis.campaigns
    FOR ALL
    USING (
        org_id = cmis.get_current_org_id()
        AND (
            -- عرض للجميع
            cmis.check_permission(cmis.get_current_user_id(), cmis.get_current_org_id(), 'campaigns.view')
            OR 
            -- تعديل للمحررين
            (TG_OP IN ('UPDATE', 'DELETE') AND 
             cmis.check_permission(cmis.get_current_user_id(), cmis.get_current_org_id(), 'campaigns.edit'))
        )
    )
    WITH CHECK (
        org_id = cmis.get_current_org_id()
        AND cmis.check_permission(cmis.get_current_user_id(), cmis.get_current_org_id(), 'campaigns.create')
    );

-- ================================================================
-- 8. دوال إدارة الجلسات
-- ================================================================

-- دالة لإنشاء جلسة جديدة
CREATE OR REPLACE FUNCTION cmis.create_user_session(
    p_user_id uuid,
    p_org_id uuid,
    p_ip_address inet DEFAULT NULL,
    p_user_agent text DEFAULT NULL
) RETURNS TABLE (
    session_id uuid,
    session_token text,
    expires_at timestamptz
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_session_id uuid;
    v_session_token text;
    v_expires_at timestamptz;
BEGIN
    -- التحقق من صلاحية المستخدم للدخول للشركة
    IF NOT EXISTS (
        SELECT 1 FROM cmis.user_orgs
        WHERE user_id = p_user_id
          AND org_id = p_org_id
          AND is_active = true
    ) THEN
        RAISE EXCEPTION 'User does not have access to this organization';
    END IF;
    
    -- إنشاء token آمن
    v_session_token := encode(gen_random_bytes(32), 'hex');
    v_expires_at := CURRENT_TIMESTAMP + INTERVAL '24 hours';
    
    -- إنشاء الجلسة
    INSERT INTO cmis.user_sessions (user_id, session_token, ip_address, user_agent, expires_at)
    VALUES (p_user_id, v_session_token, p_ip_address, p_user_agent, v_expires_at)
    RETURNING user_sessions.session_id INTO v_session_id;
    
    -- تعيين الشركة النشطة
    INSERT INTO cmis.session_context (session_id, active_org_id)
    VALUES (v_session_id, p_org_id);
    
    -- تحديث آخر وصول
    UPDATE cmis.user_orgs
    SET last_accessed = CURRENT_TIMESTAMP
    WHERE user_id = p_user_id
      AND org_id = p_org_id;
    
    -- تسجيل النشاط
    INSERT INTO cmis.user_activities (user_id, org_id, session_id, action, ip_address)
    VALUES (p_user_id, p_org_id, v_session_id, 'login', p_ip_address);
    
    RETURN QUERY SELECT v_session_id, v_session_token, v_expires_at;
END;
$$;

-- دالة لتبديل الشركة النشطة
CREATE OR REPLACE FUNCTION cmis.switch_org_context(
    p_session_token text,
    p_new_org_id uuid
) RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_session_id uuid;
    v_user_id uuid;
BEGIN
    -- الحصول على معلومات الجلسة
    SELECT us.session_id, us.user_id 
    INTO v_session_id, v_user_id
    FROM cmis.user_sessions us
    WHERE us.session_token = p_session_token
      AND us.is_active = true
      AND us.expires_at > CURRENT_TIMESTAMP;
    
    IF v_session_id IS NULL THEN
        RETURN false;
    END IF;
    
    -- التحقق من صلاحية المستخدم للشركة الجديدة
    IF NOT EXISTS (
        SELECT 1 FROM cmis.user_orgs
        WHERE user_id = v_user_id
          AND org_id = p_new_org_id
          AND is_active = true
    ) THEN
        RETURN false;
    END IF;
    
    -- تحديث السياق
    UPDATE cmis.session_context
    SET active_org_id = p_new_org_id,
        switched_at = CURRENT_TIMESTAMP
    WHERE session_id = v_session_id;
    
    -- تحديث آخر وصول
    UPDATE cmis.user_orgs
    SET last_accessed = CURRENT_TIMESTAMP
    WHERE user_id = v_user_id
      AND org_id = p_new_org_id;
    
    -- تسجيل النشاط
    INSERT INTO cmis.user_activities (user_id, org_id, session_id, action, details)
    VALUES (v_user_id, p_new_org_id, v_session_id, 'switch_org', 
            jsonb_build_object('from_org_id', cmis.get_current_org_id(), 'to_org_id', p_new_org_id));
    
    RETURN true;
END;
$$;

-- ================================================================
-- 9. إنشاء Views للإدارة
-- ================================================================

-- عرض للمستخدمين مع صلاحياتهم
CREATE OR REPLACE VIEW cmis.v_user_permissions AS
SELECT 
    u.user_id,
    u.email,
    u.display_name,
    o.org_id,
    o.name as org_name,
    r.role_name,
    array_agg(DISTINCT p.permission_code ORDER BY p.permission_code) as permissions
FROM cmis.users u
JOIN cmis.user_orgs uo ON uo.user_id = u.user_id
JOIN cmis.orgs o ON o.org_id = uo.org_id
JOIN cmis.roles r ON r.role_id = uo.role_id
LEFT JOIN cmis.role_permissions rp ON rp.role_id = r.role_id
LEFT JOIN cmis.permissions p ON p.permission_id = rp.permission_id
WHERE uo.is_active = true
GROUP BY u.user_id, u.email, u.display_name, o.org_id, o.name, r.role_name;

-- عرض للجلسات النشطة
CREATE OR REPLACE VIEW cmis.v_active_sessions AS
SELECT 
    us.session_id,
    u.email,
    u.display_name,
    o.name as active_org,
    us.created_at as login_time,
    us.last_activity,
    us.expires_at,
    us.ip_address,
    EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - us.last_activity))/60 as idle_minutes
FROM cmis.user_sessions us
JOIN cmis.users u ON u.user_id = us.user_id
LEFT JOIN cmis.session_context sc ON sc.session_id = us.session_id
LEFT JOIN cmis.orgs o ON o.org_id = sc.active_org_id
WHERE us.is_active = true
  AND us.expires_at > CURRENT_TIMESTAMP;

-- ================================================================
-- 10. فهارس للأداء
-- ================================================================

CREATE INDEX idx_user_orgs_user ON cmis.user_orgs(user_id) WHERE is_active = true;
CREATE INDEX idx_user_orgs_org ON cmis.user_orgs(org_id) WHERE is_active = true;
CREATE INDEX idx_role_permissions_role ON cmis.role_permissions(role_id);
CREATE INDEX idx_user_permissions_user_org ON cmis.user_permissions(user_id, org_id);
CREATE INDEX idx_user_activities_user ON cmis.user_activities(user_id, created_at DESC);
CREATE INDEX idx_user_activities_org ON cmis.user_activities(org_id, created_at DESC);

-- ================================================================
-- 11. دالة للتحقق من نجاح المرحلة 2
-- ================================================================

CREATE OR REPLACE FUNCTION cmis.verify_phase2_permissions()
RETURNS TABLE(
    check_name text,
    status text,
    count bigint,
    details text
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- جدول user_orgs
    RETURN QUERY
    SELECT 
        'User-Org Relationships'::text,
        'CREATED'::text,
        count(*),
        'Multi-org support enabled'::text
    FROM cmis.user_orgs;
    
    -- الأدوار
    RETURN QUERY
    SELECT 
        'Roles Created'::text,
        'READY'::text,
        count(*),
        'Role-based access control'::text
    FROM cmis.roles;
    
    -- الصلاحيات
    RETURN QUERY
    SELECT 
        'Permissions Defined'::text,
        'CONFIGURED'::text,
        count(*),
        'Granular permissions'::text
    FROM cmis.permissions;
    
    -- ربط الأدوار بالصلاحيات
    RETURN QUERY
    SELECT 
        'Role Permissions'::text,
        'ASSIGNED'::text,
        count(*),
        'Permissions assigned to roles'::text
    FROM cmis.role_permissions;
    
    -- السياسات المحدثة
    RETURN QUERY
    SELECT 
        'RLS Policies'::text,
        CASE 
            WHEN count(*) > 0 THEN 'UPDATED'::text
            ELSE 'PENDING'::text
        END,
        count(*),
        'Row-level security policies'::text
    FROM pg_policies
    WHERE schemaname = 'cmis'
      AND policyname LIKE '%_orgs_%' OR policyname LIKE '%role%';
END;
$$;

COMMIT;

-- ================================================================
-- تنفيذ التحقق
-- ================================================================
SELECT * FROM cmis.verify_phase2_permissions();

-- ================================================================
-- أمثلة للاستخدام
-- ================================================================
/*
-- إنشاء جلسة للمستخدم
SELECT * FROM cmis.create_user_session(
    'user-uuid-here'::uuid, 
    'org-uuid-here'::uuid,
    '192.168.1.1'::inet,
    'Mozilla/5.0...'
);

-- التحقق من صلاحية
SELECT cmis.check_permission(
    'user-uuid'::uuid,
    'org-uuid'::uuid,
    'campaigns.create'
);

-- الحصول على شركات المستخدم
SELECT * FROM cmis.get_user_orgs('user-uuid'::uuid);

-- تبديل الشركة النشطة
SELECT cmis.switch_org_context('session-token-here', 'new-org-uuid'::uuid);
*/

-- ================================================================
-- ملاحظات للمطور
-- ================================================================
/*
1. النظام الآن يدعم:
   - مستخدم واحد ← عدة شركات
   - جلسة واحدة ← شركة نشطة واحدة (يمكن التبديل)
   - صلاحيات مرنة على مستوى الوظيفة

2. لاستخدام النظام من التطبيق:
   - عند تسجيل الدخول: استخدم create_user_session()
   - عند كل طلب: أرسل session_token
   - لتبديل الشركة: استخدم switch_org_context()

3. الأمان:
   - كل الدوال الحساسة محمية بـ SECURITY DEFINER
   - RLS يعمل تلقائياً بناءً على السياق
   - كل النشاطات مسجلة

للانتقال للمرحلة 3، نفذ: phase3_performance_optimization.sql
*/
