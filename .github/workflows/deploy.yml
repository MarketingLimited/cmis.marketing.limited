---
# yamllint disable rule:truthy
name: Deploy

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  deploy-staging:
    name: Deploy to Staging
    if: >-
      github.ref == 'refs/heads/staging' ||
      (github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.cmis.kazaaz.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, bcmath, pdo_pgsql, intl
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: |
          composer install \
            --prefer-dist \
            --no-progress \
            --no-interaction \
            --no-dev \
            --optimize-autoloader

      - name: Install npm dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Deploy to staging server
        uses: easingthemes/ssh-deploy@v5
        with:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.STAGING_HOST }}
          REMOTE_USER: ${{ secrets.STAGING_USER }}
          TARGET: ${{ secrets.STAGING_PATH }}
          EXCLUDE: |
            .git
            .github
            node_modules
            tests
            storage/logs
            .env
            .env.example

      - name: Run post-deployment commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.STAGING_PATH }}
            php artisan down
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize
            php artisan queue:restart
            php artisan up

  deploy-production:
    name: Deploy to Production
    if: >-
      github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://cmis.kazaaz.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, bcmath, pdo_pgsql, intl
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: |
          composer install \
            --prefer-dist \
            --no-progress \
            --no-interaction \
            --no-dev \
            --optimize-autoloader

      - name: Install npm dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deployment
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='storage/logs' \
            --exclude='.env' \
            . deployment/

      - name: Deploy to production server
        uses: easingthemes/ssh-deploy@v5
        with:
          SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.PRODUCTION_HOST }}
          REMOTE_USER: ${{ secrets.PRODUCTION_USER }}
          TARGET: ${{ secrets.PRODUCTION_PATH }}
          SOURCE: deployment/

      - name: Create database backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.PRODUCTION_PATH }}
            mkdir -p backups
            export PGPASSWORD="${{ secrets.PRODUCTION_DB_PASSWORD }}"
            pg_dump \
              -h 127.0.0.1 \
              -U ${{ secrets.PRODUCTION_DB_USER }} \
              -d ${{ secrets.PRODUCTION_DB_NAME }} \
              > "backups/backup_$(date +%Y%m%d_%H%M%S).sql"

      - name: Run deployment commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.PRODUCTION_PATH }}
            php artisan down --message="Deploying new version. Back soon!"
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize
            php artisan queue:restart
            php artisan up

      - name: Health check
        run: |
          sleep 5
          curl -f https://cmis.kazaaz.com || exit 1

      - name: Notify deployment success
        if: success()
        run: echo "✅ Deployment to production successful!"

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.PRODUCTION_PATH }}
            git reset --hard HEAD~1
            php artisan migrate:rollback --force
            php artisan optimize:clear
            php artisan up
            echo "⚠️ Deployment failed and was rolled back!"
