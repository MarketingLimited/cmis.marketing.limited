# ๐๏ธ ุชูุฑูุฑ ุญุงูุฉ ูุดุฑูุน CMIS ูุฎุทุฉ ุงูุชุทููุฑ

## ๐ ุชูููู ุงููุถุน ุงูุญุงูู (As-Is Analysis)

ุจูุงุกู ุนูู ุงูุชุญููู ุงูุดุงูู ููููู ุงููุดุฑูุน ููุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุฐุง ูู ุชูููู ุงููุถุน ุงูุญุงูู ูุชุทุจูู Laravel Backend.

### โ ูุง ุชู ุฅูุฌุงุฒู

1.  **ูุงุนุฏุฉ ุจูุงูุงุช ูุชูุฏูุฉ:**
    *   ุชู ุชุตููู ูุชูููุฐ ูุฎุทุท ูุงุนุฏุฉ ุจูุงูุงุช PostgreSQL ุดุงูู ููุชุทูุฑ (`database/schema.sql`) ูุถู ุฃูุซุฑ ูู 148 ุฌุฏูู ุนุจุฑ 12 `schema`.
    *   ุชู ุจูุงุก ูุธุงู ุฃูุงู ููู ูุนุชูุฏ ุนูู RLS (Row Level Security) ูุน ูุธุงุฆู ูุณูุงูุงุช ุฃูุงู (`SET LOCAL`).
    *   ุชู ุฏูุฌ `pgvector` ูุฏุนู ุงูุจุญุซ ุงูุฏูุงูู (Semantic Search).

2.  **ููููุฉ ูุชูุฏูุฉ ูููุณุงุฑุงุช (Routes):**
    *   ููู `routes/api.php` ููุธู ุจุดูู ููุชุงุฒ ููููุฃ ุจุงููุงูู ูุฏุนู ุจููุฉ ุงูุดุฑูุงุช ุงููุชุนุฏุฏุฉ (Multi-tenancy).
    *   ุงููุณุงุฑุงุช ููุณูุฉ ุจูุถูุญ ุฅูู ูุณุงุฑุงุช ูููุตุงุฏูุฉุ ูููุณุชุฎุฏูุ ูููุดุฑูุฉ (`/orgs/{org_id}`).
    *   ุชู **ุงูุชุฎุทูุท** ูุงุณุชุฎุฏุงู ุทุจูุฉ Middleware ุฃูููุฉ (`validate.org.access`, `set.db.context`) ุนูู ูุณุชูู ุงููุณุงุฑุงุช.

3.  **ูุฌูุฏ Controllers ูุฃูุงูุฑ Artisan:**
    *   ุชู ุฅูุดุงุก ุงูุนุฏูุฏ ูู ูููุงุช `Controllers` ุถูู ูููู ููุธู (e.g., `app/Http/Controllers/Core`, `app/Http/Controllers/Campaigns`).
    *   ุชูุฌุฏ ุฃูุงูุฑ Artisan ูุฎุตุตุฉ ูููุฒุงููุฉ ูุงููุฑุงูุจุฉ (`SyncInstagramData`, `CognitiveVitalityLog`) ููุณุฌูุฉ ูู `app/Console/Kernel.php`.
    *   ุชู ุฌุฏููุฉ ุงูุนุฏูุฏ ูู ุงูููุงู ุงูุฑุฆูุณูุฉ ููุนูู ุจุดูู ุฏูุฑู (e.g., `sync:all`, `embeddings:generate`).

### โ๏ธ ูุง ูุญุชุงุฌ ุฅูู ุชูููุฐ (To-Be)

1.  **ุทุจูุฉ ุงูุฃูุงู (Middleware):**
    *   ูุฌูุฏ `app/Http/Middleware` ุบูุฑ ููุฌูุฏ ุญุงูููุง.
    *   ูููุงุช Middleware ูุซู `SetDatabaseContext.php` ู `ValidateOrgAccess.php` ุงูุชู ุชู ุงุณุชุฏุนุงุคูุง ูู `routes/api.php` **ุชุญุชุงุฌ ุฅูู ุฅูุดุงุก ูุชูุนูู**.
    *   ููู `app/Http/Kernel.php` (ุฃู ุงูุชุนุฏูู ุนูู `bootstrap/app.php` ูู Laravel 11+) ูุญุชุงุฌ ุฅูู ุชุญุฏูุซ ูุชุณุฌูู ูุฐู ุงูู Middleware.

2.  **ุทุจูุฉ ุงูุจูุงูุงุช (Eloquent Models):**
    *   ูุนุธู ุงูู Modelsุ ุจูุง ูู ุฐูู `User.php`ุ ูุง ุชุฒุงู ูู ุญุงูุชูุง ุงูุงูุชุฑุงุถูุฉ.
    *   ุชุญุชุงุฌ ุฌููุน ุงูู Models ุฅูู ุชุญุฏูุซ ูุชุญุฏูุฏ `schema`, `table`, `primaryKey` ูุชูุนูู `SoftDeletes` ุนูุฏ ุงูุญุงุฌุฉ.
    *   ููุฏูู `User.php` ูุญุชุงุฌ ุฅูู ุชุนุฏูู ุฌุฐุฑู ูุฅุถุงูุฉ ุนูุงูุฉ `belongsToMany` ูุน `Orgs` ูุฏุนู ูููู ุงูุดุฑูุงุช ุงููุชุนุฏุฏุฉ.
    *   ููุฒู ุฅูุดุงุก Models ุฌุฏูุฏุฉ ูุซู `Org`, `Role`, `UserOrg` ูุบูุฑูุง ุงููุซูุฑ.

3.  **ุชูููุฐ ููุทู ุงูู Controllers:**
    *   ุนูู ุงูุฑุบู ูู ูุฌูุฏ ูููุงุช ุงูู Controllersุ ุฅูุง ุฃู ุงูููุทู ุงูุฏุงุฎูู ููุง ูุญุชุงุฌ ุฅูู ูุฑุงุฌุนุฉ ูุชูููุฉ ููุชูุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ููุธุงู ุงูุฃูุงู.

---

## ๐ ุฎุทุฉ ุนูู Laravel Backend (ุงููุชุจููุฉ)

ูุฐู ุงูุฎุทุฉ ูู ุฎุงุฑุทุฉ ุงูุทุฑูู **ุงููุญุฏุซุฉ** ูุฅููุงู ุฑุจุท Laravel ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุชูุฏูุฉ.

### ุงููุฑุญูุฉ ุงูุฃููู: ุชูุนูู ุงูุฃุณุงุณ ุงูุฃููู (Security Core) - **ุงูุฃููููุฉ ุงููุตูู**

**ุงููุฏู:** ุชูููุฐ ุทุจูุฉ ุงูู Middleware ุงูุชู ุชู ุงูุชุฎุทูุท ููุง ุจุงููุนู.

1.  **ุฅูุดุงุก Middleware ูุฅุฏุงุฑุฉ ุงูุณูุงู:**
    *   **ุงูููู:** `app/Http/Middleware/SetDatabaseContext.php` (ุฌุฏูุฏ).
    *   **ุงููููุฉ:** ูุณุชูุจู ุงูุทูุจุ ูุณุชุฎุฑุฌ `user_id` ู `org_id`ุ ููููุฐ `DB::statement("SELECT cmis.init_transaction_context(?, ?)", ...)` ุถูู ูุนุงููุฉ (Transaction).
2.  **ุฅูุดุงุก Middleware ููุชุญูู ูู ุงูุตูุงุญูุฉ:**
    *   **ุงูููู:** `app/Http/Middleware/ValidateOrgAccess.php` (ุฌุฏูุฏ).
    *   **ุงููููุฉ:** ูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ุนุถู ูุนุงู ูู ุงูุดุฑูุฉ ุงููุทููุจุฉ (`org_id`) ุนุจุฑ ุฌุฏูู `cmis.user_orgs`.
3.  **ุชุณุฌูู ุงูู Middleware:**
    *   **ุงูููู:** ุชุญุฏูุซ `bootstrap/app.php`.
    *   **ุงููููุฉ:** ุชุณุฌูู ุงูุฃุณูุงุก ุงููุณุชุนุงุฑุฉ ููู Middleware:
        ```php
        $middleware->alias([
            'set.db.context' => \App\Http\Middleware\SetDatabaseContext::class,
            'validate.org.access' => \App\Http\Middleware\ValidateOrgAccess::class,
        ]);
        ```

### ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุจูุงุก ุทุจูุฉ ุงูุจูุงูุงุช (Models)

**ุงููุฏู:** ุฌุนู ุงูู Models ูุชูุงููุฉ 100% ูุน ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช.

1.  **ุชุญุฏูุซ `User.php`:**
    *   **ุงูููู:** `app/Models/User.php`.
    *   **ุงููููุฉ:**
        *   ุฅุถุงูุฉ `use SoftDeletes;`.
        *   ุชุญุฏูุฏ `protected $table = 'cmis.users';` ู `protected $primaryKey = 'user_id';`.
        *   ุฅุฒุงูุฉ `org_id` ุงููุฏูู.
        *   ุฅุถุงูุฉ ุนูุงูุฉ `orgs()` ุงูุฌุฏูุฏุฉ (`belongsToMany`).
2.  **ุฅูุดุงุก ุงูู Models ุงูุฃุณุงุณูุฉ:**
    *   **ุงููููุงุช:** `app/Models/Core/Org.php`, `app/Models/Core/Role.php`, `app/Models/Core/UserOrg.php`.
    *   **ุงููููุฉ:** ุฅูุดุงุคูุง ูุชุญุฏูุฏ ุฎุตุงุฆุตูุง ูุนูุงูุงุชูุง ุจุดูู ุตุญูุญ.
3.  **ุฅูุดุงุก ุจุงูู ุงูู Models:**
    *   **ุงููููุฉ:** ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุฌููุน ุงูู Models ุงูุฃุฎุฑู (`Campaign`, `CreativeAsset`, etc.) ูุน ุชุญุฏูุฏ ุงูู `schema` ุงูุตุญูุญ ูุชูุนูู `SoftDeletes`. ุชูุธูููุง ูู ูุฌูุฏุงุช ูุฑุนูุฉ ููุง ูู ููุชุฑุญ ูู ุฎุทุชู.

### ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุชูููู ุฃูุงูุฑ Artisan

**ุงููุฏู:** ุถูุงู ุนูู ุงูุฃูุงูุฑ ุงูุฎูููุฉ ุจุฃูุงู ูุน ูุธุงู RLS.

1.  **ุฅูุดุงุก "System User":**
    *   **ุงููููุฉ (ูุฏููุงู):** ุฅูุดุงุก ูุณุชุฎุฏู ูุธุงู ูุงุญุฏ ูู `cmis.users` ูููุญู ุตูุงุญูุงุช ุนูู ูู ุงูุดุฑูุงุช.
2.  **ุฅูุดุงุก Trait ููุฃูุงูุฑ:**
    *   **ุงูููู:** `app/Console/Traits/HandlesOrgContext.php` (ุฌุฏูุฏ).
    *   **ุงููููุฉ:** ูุญุชูู ุนูู ุฏุงูุฉ `executePerOrg` ุงูุชู ุชููู ุจุฌูุจ ูู ุงูุดุฑูุงุชุ ูุชุถุจุท ุงูุณูุงู (`init_transaction_context`) ููู ุดุฑูุฉ ุนูู ุญุฏุฉุ ุซู ุชููุฐ ุงูููุทู ุงููุทููุจ.
3.  **ุชุญุฏูุซ ุงูุฃูุงูุฑ ุงูุญุงููุฉ:**
    *   **ุงููููุฉ:** ุชุนุฏูู ุงูุฃูุงูุฑ ูุซู `SyncInstagramData` ูุชุณุชุฎุฏู ุงูู `trait` ุงูุฌุฏูุฏ ูุถูุงู ุชุดุบูููุง ุถูู ุณูุงู ุขูู ููู ุดุฑูุฉ.

### ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ: ุฅููุงู ููุทู ุงูู API Endpoints

**ุงููุฏู:** ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูู Controllers ุชุนูู ุจุดูู ุตุญูุญ ูุน ุงูุจููุฉ ุงูุฌุฏูุฏุฉ.

1.  **ูุฑุงุฌุนุฉ `AuthController`:** ุงูุชุฃูุฏ ูู ุฃู ุนูููุงุช ุงูุชุณุฌูู ูุชุณุฌูู ุงูุฏุฎูู ุชุนูู ูุน ููุฏูู `User` ุงููุญุฏุซ.
2.  **ุจูุงุก `OrgController` ู `UserController`:** ุชูููุฐ ููุทู ุฏุนูุฉ ุงููุณุชุฎุฏูููุ ูุฅูุดุงุก ุงูุดุฑูุงุชุ ูุชุญุฏูุซ ุงูุฃุฏูุงุฑ.
3.  **ุจูุงุก ุจุงูู ุงูู Controllers:** ุฅููุงู ููุทู ุงูุนูููุงุช ูุจุงูู ุงูู Controllers (`CampaignController`, `CreativeAssetController`, ุฅูุฎ) ูุน ุงูุงุนุชูุงุฏ ุงููุงูู ุนูู RLS ูุชุฃููู ุงูุจูุงูุงุช.

---

## ๐ ุจููุฉ ุงูู Connectors ููุชูุงูู ูุน ุงูููุตุงุช ุงูุฎุงุฑุฌูุฉ

ููุชุนุงูู ูุน ุงูุนุฏุฏ ุงููุจูุฑ ูู ุงูุชูุงููุงุช ุงููุทููุจุฉ (Meta, Google, TikTok, etc.)ุ ุชู ุชุตููู ูุชูููุฐ ุจููุฉ `Connector` ูุฑูุฉ ููุงุจูุฉ ููุชูุณุน. ูุฐุง ุงูุฃุณููุจ ููุตู ููุทู ูู ููุตุฉ ูู ูุญุฏุฉ ุฎุงุตุฉ ุจูุงุ ููุง ูุณูู ุงูุตูุงูุฉ ูุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุชูุงููุงุช ูู ุงููุณุชูุจู.

### ุงูููููุงุช ุงูุฃุณุงุณูุฉ

1.  **`ConnectorInterface` (ุงููุงุฌูุฉ ุงูููุญุฏุฉ):**
    *   **ุงููููุน:** `app/Services/Connectors/Contracts/ConnectorInterface.php`
    *   **ุงูุบุฑุถ:** ุชุญุฏุฏ "ุงูุนูุฏ" ุฃู ูุฌููุนุฉ ุงููุธุงุฆู ุงููุดุชุฑูุฉ ุงูุชู ูุฌุจ ุนูู ูู Connector ุชูููุฐูุง. ูุฐุง ูุถูู ุฃู ุงูุชุทุจูู ููููู ุงูุชุนุงูู ูุน ุฃู connector ุจููุณ ุงูุทุฑููุฉ.
    *   **ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**
        *   `connect()`: ูุฑุจุท ุญุณุงุจ ุฌุฏูุฏ.
        *   `disconnect()`: ููุตู ุญุณุงุจ.
        *   `syncCampaigns()`: ููุฒุงููุฉ ุงูุญููุงุช ุงูุฅุนูุงููุฉ.
        *   `syncPosts()`: ููุฒุงููุฉ ููุดูุฑุงุช ุงูุณูุดูุงู ููุฏูุง.
        *   `publishPost()`: ููุดุฑ ูุญุชูู ุฌุฏูุฏ.

2.  **`ConnectorFactory` (ุงููุตูุน):**
    *   **ุงููููุน:** `app/Services/Connectors/ConnectorFactory.php`
    *   **ุงูุบุฑุถ:** ูู ููุทุฉ ุงูุฏุฎูู ุงูููุญุฏุฉ ูุฅูุดุงุก ุฃู connector. ุจุฏูุงู ูู ุฅูุดุงุก ุงููุงุฆูุงุช ูุฏูููุง ูู ูู ููุงูุ ููููู ุจุจุณุงุทุฉ ุงุณุชุฏุนุงุก `ConnectorFactory::make('meta')`.
    *   **ุงูููุฒุฉ:** ุฅุฐุง ุงุญุชุฌูุง ุฅูู ุชุบููุฑ ููููุฉ ุฅูุดุงุก `MetaConnector` ูู ุงููุณุชูุจูุ ูุฅููุง ูุบูุฑู ูู ููุงู ูุงุญุฏ ููุท.

3.  **ุงูู Connectors ุงููุนููุฉ (Providers):**
    *   **ุงููููุน:** `app/Services/Connectors/Providers/`
    *   **ุงูุบุฑุถ:** ูู ููู ููุง ููุซู ุงูุชูููุฐ ุงููุนูู ูููุตุฉ ูุนููุฉ. ููุฏ ุชู ุฅูุดุงุก ุงูููุงูู ุงูุฃุณุงุณูุฉ ูู:
        *   `MetaConnector.php`: ููุชุนุงูู ูุน Facebook ู Instagram.
        *   `GoogleConnector.php`: ููุชุนุงูู ูุน Google Ads ู Analytics.
    *   **ููููุฉ ุฅุถุงูุฉ connector ุฌุฏูุฏ (ูุซู TikTok):**
        1.  ุฃูุดุฆ `TikTokConnector.php` ูู ููุณ ุงููุฌูุฏ.
        2.  ุงุฌุนูู ูููุฐ `ConnectorInterface`.
        3.  ุงูุชุจ ููุทู ุงูุชุนุงูู ูุน TikTok API ุฏุงุฎู ุงููุธุงุฆู ุงููุญุฏุฏุฉ.
        4.  ุฃุถู ` 'tiktok' => TikTokConnector::class` ุฅูู `$connectorMap` ูู `ConnectorFactory.php`.

### ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ

1.  **`sync:platform` (ุฃูุฑ Artisan):**
    *   **ุงููููุน:** `app/Console/Commands/SyncPlatform.php`
    *   **ุงูุบุฑุถ:** ุฃูุฑ ููุญุฏ ูุชุดุบูู ุนูููุงุช ุงููุฒุงููุฉ ูู ุณุทุฑ ุงูุฃูุงูุฑ.
    *   **ุงูุงุณุชุฎุฏุงู:** `php artisan sync:platform meta --org=UUID` ููุฒุงููุฉ ุจูุงูุงุช Meta ูุดุฑูุฉ ูุนููุฉ.

2.  **`PublishingService` (ุฎุฏูุฉ ุงููุดุฑ):**
    *   **ุงููููุน:** `app/Services/PublishingService.php`
    *   **ุงูุบุฑุถ:** ุชุญุชูู ุนูู ููุทู ุงูุนุซูุฑ ุนูู ุงููุญุชูู ุงููุฌุฏูู ูุงุณุชุฎุฏุงู ุงูู Connector ุงูููุงุณุจ ููุดุฑู.
    *   **ุงูุชุดุบูู:** ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฎุฏูุฉ ูู ุฎูุงู ุงูููุงู ุงููุฌุฏููุฉ ูู Laravel (e.g., ูู ุฏูููุฉ).
