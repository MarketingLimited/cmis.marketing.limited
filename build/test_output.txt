
  [30;43;1m WARN [39;49;22m Your XML configuration validates against a deprecated schema. Migrate your XML configuration using "--migrate-configuration"!
PHPUnit 11.5.42 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.14
Configuration: /home/user/cmis.marketing.limited/phpunit.xml
Random Seed:   1763581925


   FAIL  Tests\Feature\CampaignTest
  â¨¯ example                                                              0.56s  
Enabling RLS on cmis.orgs...
Enabling RLS on cmis.org_markets...
Enabling RLS on cmis.user_orgs...
Enabling RLS on cmis.campaigns...
Enabling RLS on cmis.content_plans...
Enabling RLS on cmis.content_items...
Enabling RLS on cmis.creative_assets...
Enabling RLS on cmis.ad_accounts...
Enabling RLS on cmis.ad_campaigns...
Enabling RLS on cmis.ad_sets...
Enabling RLS on cmis.ad_entities...
Enabling RLS on cmis.ad_metrics...
Creating RLS policy for cmis.orgs...
Creating RLS policy for cmis.org_markets...
Creating RLS policy for cmis.user_orgs...
Creating RLS policy for cmis.campaigns...
Creating RLS policy for cmis.content_plans...
Creating RLS policy for cmis.content_items...
Creating RLS policy for cmis.creative_assets...
Creating RLS policy for cmis.ad_accounts...
Creating RLS policy for cmis.ad_campaigns...
Creating RLS policy for cmis.ad_sets...
Creating RLS policy for cmis.ad_entities...
Creating RLS policy for cmis.ad_metrics...
Row-Level Security enabled successfully!

âš ï¸  CRITICAL MIGRATION: Converting users.user_id from BIGINT to UUID
This will invalidate all existing user sessions and API tokens.
Press Ctrl+C within 10 seconds to abort...

Step 1/10: Checking current schema...
âœ“ Users table already uses UUID. Skipping migration.

ðŸ“Š Adding performance indexes...

Creating indexes for campaigns table...
âœ“ Created index: idx_campaigns_org_status
âœ“ Created index: idx_campaigns_dates
âœ“ Created index: idx_campaigns_created
Creating indexes for content_plans table...
âœ“ Created index: idx_content_plans_campaign
âœ“ Created index: idx_content_plans_org_created
Creating indexes for content_items table...
âœ“ Created index: idx_content_items_plan
âœ“ Created index: idx_content_items_status
Creating indexes for ad_accounts table...
âœ“ Created index: idx_ad_accounts_status
Creating indexes for ad_campaigns table...
âš  Warning: Could not create index idx_ad_campaigns_account: SQLSTATE[42703]: Undefined column: 7 ERROR:  column "ad_account_id" does not exist (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_campaigns_account
                    ON cmis.ad_campaigns (ad_account_id, status)
                )
âš  Warning: Could not create index idx_ad_campaigns_dates: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_campaigns_dates
                    ON cmis.ad_campaigns (start_date, end_date)
                )
Creating indexes for ad_metrics table...
âš  Warning: Could not create index idx_ad_metrics_entity_date: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_metrics_entity_date
                    ON cmis.ad_metrics (ad_entity_id, recorded_at DESC)
                )
âš  Warning: Could not create index idx_ad_metrics_date: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_metrics_date
                    ON cmis.ad_metrics (recorded_at DESC)
                )
âš  Warning: Could not create index idx_ad_metrics_campaign: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_metrics_campaign
                    ON cmis.ad_metrics (ad_campaign_id, recorded_at DESC)
                )
Creating indexes for user_orgs table...
âš  Warning: Could not create index idx_user_orgs_user: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_user_orgs_user
                    ON cmis.user_orgs (user_id, is_active)
                )
âš  Warning: Could not create index idx_user_orgs_org: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_user_orgs_org
                    ON cmis.user_orgs (org_id, is_active)
                )
Creating indexes for creative_assets table...
âš  Warning: Could not create index idx_creative_assets_org: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_creative_assets_org
                    ON cmis.creative_assets (org_id, asset_type)
                )
âš  Warning: Could not create index idx_creative_assets_created: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_creative_assets_created
                    ON cmis.creative_assets (created_at DESC)
                )
Creating indexes for compliance_audits table...
âš  Warning: Could not create index idx_compliance_audits_content: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_compliance_audits_content
                    ON cmis.compliance_audits (content_item_id)
                )
âš  Warning: Could not create index idx_compliance_audits_status: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_compliance_audits_status
                    ON cmis.compliance_audits (status, created_at DESC)
                )
Creating indexes for activity_logs table...
âš  Warning: Could not create index idx_audit_user_date: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_audit_user_date
                    ON cmis_audit.activity_logs (user_id, created_at DESC)
                )
âš  Warning: Could not create index idx_audit_action: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_audit_action
                    ON cmis_audit.activity_logs (action, created_at DESC)
                )
âš  Warning: Could not create index idx_audit_model: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_audit_model
                    ON cmis_audit.activity_logs (model_type, model_id)
                )
Creating indexes for personal_access_tokens table...
âš  Warning: Could not create index idx_tokens_tokenable: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_tokens_tokenable
                    ON personal_access_tokens (tokenable_type, tokenable_id)
                )
âš  Warning: Could not create index idx_tokens_created: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_tokens_created
                    ON personal_access_tokens (created_at DESC)
                )

âœ“ All performance indexes created successfully!
âœ“ Query performance should be significantly improved


ðŸ“Š Adding foreign key constraints for user reference columns...

âš ï¸  Could not add FK fk_user_permissions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_user_activities_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_user_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_scheduled_social_posts_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_security_context_audit_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_audience_templates_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_campaign_context_links_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_campaigns_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_integrations_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_roles_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_campaign_context_links_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_integrations_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_team_invitations_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_user_orgs_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...

âœ… Foreign key migration complete!
   Added: 0
   Skipped: 15

âœ“ Fixed performance_metrics constraints
âœ“ Notifications table created with RLS policies

ðŸ“Š Creating foreign keys directly...

âš ï¸  Could not add FK fk_user_permissions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_user_activities_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_user_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_scheduled_social_posts_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_security_context_audit_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_notifications_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_audience_templates_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_campaign_context_links_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_campaigns_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_integrations_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_roles_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_campaign_context_links_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_integrations_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_team_invitations_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_user_orgs_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âœ“ Added FK: fk_notifications_org on cmis.notifications.org_id -> cmis.orgs.org_id

âœ… Foreign key creation complete!
   Added: 1
   Skipped: 16

âœ“ Added updated_at to cmis.orgs
âœ“ Added created_at to cmis.user_orgs
âœ“ Added updated_at to cmis.user_orgs
âœ“ Added created_at to cmis.org_markets
âœ“ Added updated_at to cmis.org_markets
âœ“ Added updated_at to cmis.ad_campaigns
âœ“ Added updated_at to cmis.ad_metrics
âœ“ Added updated_at to cmis.ai_actions
âœ“ Added updated_at to cmis.ai_generated_campaigns
âœ“ Added updated_at to cmis.ai_models
âœ“ Added updated_at to cmis.cognitive_tracker_template
âœ“ Added updated_at to cmis.cognitive_trends
âœ“ Added updated_at to cmis.compliance_audits
âœ“ Added updated_at to cmis.content_plans
âœ“ Added updated_at to cmis.contexts
âœ“ Added updated_at to cmis.contexts_base
âœ“ Added updated_at to cmis.copy_components
âœ“ Added updated_at to cmis.creative_assets
âœ“ Added updated_at to cmis.creative_briefs
âœ“ Added updated_at to cmis.experiments
âœ“ Added updated_at to cmis.export_bundles
âœ“ Added updated_at to cmis.field_definitions
âœ“ Added updated_at to cmis.field_values
âœ“ Added updated_at to cmis.job_batches
âœ“ Added updated_at to cmis.jobs
âœ“ Added updated_at to cmis.meta_documentation
âœ“ Added updated_at to cmis.meta_field_dictionary
âœ“ Added updated_at to cmis.meta_function_descriptions
âœ“ Added updated_at to cmis.offerings_full_details
âœ“ Added updated_at to cmis.offerings_old
âœ“ Added updated_at to cmis.password_reset_tokens
âœ“ Added updated_at to cmis.predictive_visual_engine
âœ“ Added updated_at to cmis.reference_entities
âœ“ Added updated_at to cmis.roles
âœ“ Added updated_at to cmis.security_context_audit
âœ“ Added updated_at to cmis.social_post_metrics
âœ“ Added updated_at to cmis.social_posts
âœ“ Added updated_at to cmis.team_account_access
âœ“ Added updated_at to cmis.user_activities
âœ“ Added updated_at to cmis.user_sessions
âœ“ Added updated_at to cmis.value_contexts
âœ“ Added created_at to cmis.permissions
âœ“ Added updated_at to cmis.permissions
âœ“ Added created_at to cmis.role_permissions
âœ“ Added updated_at to cmis.role_permissions
âœ“ Added created_at to cmis.user_permissions
âœ“ Added updated_at to cmis.user_permissions
âœ“ Added created_at to cmis.social_accounts
âœ“ Added created_at to cmis.team_invitations
âœ“ Added updated_at to cmis.team_invitations
âœ“ Added created_at to cmis.sessions
âœ“ Added updated_at to cmis.sessions
âœ“ Added current_org_id to cmis.users
âœ“ Added status to cmis.users
âœ“ Added id column to cmis.notifications
âœ“ Created transaction context functions
âœ“ Added notifiable_type and notifiable_id to cmis.notifications
âœ“ Added post_id to cmis.scheduled_social_posts
âœ“ Added metadata to cmis.users
âœ“ Added primary key to cmis.users(user_id)
âœ“ Added account_username to cmis.integrations
âœ“ Added account_name to cmis.integrations
âœ“ Added refresh_token to cmis.integrations
âœ“ Added token_expires_at to cmis.integrations
âœ“ Added expires_at to cmis.integrations
âœ“ Added status to cmis.integrations
âœ“ Added metadata to cmis.integrations
âœ“ Added scopes to cmis.integrations
âœ“ Added user_org_id to cmis.user_orgs
âœ“ Added invited_at to cmis.user_orgs
âœ“ Made campaign_external_id nullable in cmis.ad_campaigns
âœ“ Created table: cmis.team_members
âœ“ Created table: cmis.leads
âœ“ Created table: cmis.webhooks
âœ“ Created table: cmis.contacts
âœ“ Created table: cmis.knowledge_index
âœ“ Created table: cmis.subscriptions
âœ“ Created table: cmis.api_logs
âœ“ Created table: cmis.content_plan_items
âœ“ Created table: cmis.offerings
âœ“ Created table: cmis.content
âœ“ Created table: cmis.platform_connections
âœ“ Created table: cmis.assets
âœ“ Created table: cmis.invoices
âœ“ Created table: cmis.audiences
âœ“ Created table: cmis.templates
âœ“ Created table: cmis.posts
âœ“ Created table: cmis.custom_fields
âœ“ Created table: cmis.comments
âœ“ Created table: cmis.budgets
âœ“ Created table: cmis.audit_logs

âœ… Migration complete! Created 20 missing tables.
âœ“ Added code column to public.markets
âœ“ Updated cmis.markets view to include code column
âœ“ Added name column to cmis.permissions

âœ… Added missing columns successfully!
âœ“ Created table: cmis.audience_segments
âœ“ Created table: cmis.analytics_snapshots
âœ“ Created table: cmis.analytics_reports
âœ“ Created table: cmis.activities
âœ“ Created table: cmis.workflows
âœ“ Created table: cmis.tags
âœ“ Created table: cmis.notification_preferences
âœ“ Created table: cmis.metrics
âœ“ Created table: cmis.content_media
âœ“ Created table: cmis.campaign_budgets

âœ… Migration complete! Created 10 additional tables.
âœ“ Added team_member_id to team_members
âœ“ Added updated_at to api_logs
âœ“ Added name to markets
âœ“ Added knowledge_id to knowledge_index
âœ“ Added platform to posts
âœ“ Added commentable_type to comments
âœ“ Added commentable_id to comments
âœ“ Added total_amount to budgets
âœ“ Added title to knowledge_index
âœ“ Added score to leads
âœ“ Added log_id to audit_logs

âœ… All column fixes applied successfully!
âœ“ Created table: cmis.activity_logs
âœ“ Created table: cmis.settings
âœ“ Created table: cmis.schedules
âœ“ Created table: cmis.campaign_analytics
âœ“ Created table: cmis.social_posts_v2
âœ“ Created table: cmis.social_accounts_v2
âœ“ Created table: cmis.content_plans_v2
âœ“ Created table: cmis.scheduled_social_posts_v2
âœ“ Created table: cmis.embeddings_cache
âœ“ Created table: cmis.campaign_metrics

âœ… Migration complete! Created 10 additional tables.
âœ“ Made event_type nullable in webhooks
âœ“ Made plan_id nullable in content_plan_items
âœ“ Made role_name nullable in roles
âœ“ Made permission_code nullable in permissions
âœ“ Made brief_data nullable in creative_briefs

âœ… All NULL constraint fixes applied!
âœ“ Added usage_count to assets
âœ“ Added report_name to analytics_reports
âœ“ Added activity_id to activity_logs
Enabling RLS on cmis.orgs...
Enabling RLS on cmis.org_markets...
Enabling RLS on cmis.user_orgs...
Enabling RLS on cmis.campaigns...
Enabling RLS on cmis.content_plans...
Enabling RLS on cmis.content_items...
Enabling RLS on cmis.creative_assets...
Enabling RLS on cmis.ad_accounts...
Enabling RLS on cmis.ad_campaigns...
Enabling RLS on cmis.ad_sets...
Enabling RLS on cmis.ad_entities...
Enabling RLS on cmis.ad_metrics...
Creating RLS policy for cmis.orgs...
Creating RLS policy for cmis.org_markets...
Creating RLS policy for cmis.user_orgs...
Creating RLS policy for cmis.campaigns...
Creating RLS policy for cmis.content_plans...
Creating RLS policy for cmis.content_items...
Creating RLS policy for cmis.creative_assets...
Creating RLS policy for cmis.ad_accounts...
Creating RLS policy for cmis.ad_campaigns...
Creating RLS policy for cmis.ad_sets...
Creating RLS policy for cmis.ad_entities...
Creating RLS policy for cmis.ad_metrics...
Row-Level Security enabled successfully!

âš ï¸  CRITICAL MIGRATION: Converting users.user_id from BIGINT to UUID
This will invalidate all existing user sessions and API tokens.
Press Ctrl+C within 10 seconds to abort...

Step 1/10: Checking current schema...
âœ“ Users table already uses UUID. Skipping migration.

ðŸ“Š Adding performance indexes...

Creating indexes for campaigns table...
âœ“ Created index: idx_campaigns_org_status
âœ“ Created index: idx_campaigns_dates
âœ“ Created index: idx_campaigns_created
Creating indexes for content_plans table...
âœ“ Created index: idx_content_plans_campaign
âœ“ Created index: idx_content_plans_org_created
Creating indexes for content_items table...
âœ“ Created index: idx_content_items_plan
âœ“ Created index: idx_content_items_status
Creating indexes for ad_accounts table...
âœ“ Created index: idx_ad_accounts_status
Creating indexes for ad_campaigns table...
âš  Warning: Could not create index idx_ad_campaigns_account: SQLSTATE[42703]: Undefined column: 7 ERROR:  column "ad_account_id" does not exist (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_campaigns_account
                    ON cmis.ad_campaigns (ad_account_id, status)
                )
âš  Warning: Could not create index idx_ad_campaigns_dates: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_campaigns_dates
                    ON cmis.ad_campaigns (start_date, end_date)
                )
Creating indexes for ad_metrics table...
âš  Warning: Could not create index idx_ad_metrics_entity_date: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_metrics_entity_date
                    ON cmis.ad_metrics (ad_entity_id, recorded_at DESC)
                )
âš  Warning: Could not create index idx_ad_metrics_date: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_metrics_date
                    ON cmis.ad_metrics (recorded_at DESC)
                )
âš  Warning: Could not create index idx_ad_metrics_campaign: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_ad_metrics_campaign
                    ON cmis.ad_metrics (ad_campaign_id, recorded_at DESC)
                )
Creating indexes for user_orgs table...
âš  Warning: Could not create index idx_user_orgs_user: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_user_orgs_user
                    ON cmis.user_orgs (user_id, is_active)
                )
âš  Warning: Could not create index idx_user_orgs_org: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_user_orgs_org
                    ON cmis.user_orgs (org_id, is_active)
                )
Creating indexes for creative_assets table...
âš  Warning: Could not create index idx_creative_assets_org: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_creative_assets_org
                    ON cmis.creative_assets (org_id, asset_type)
                )
âš  Warning: Could not create index idx_creative_assets_created: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_creative_assets_created
                    ON cmis.creative_assets (created_at DESC)
                )
Creating indexes for compliance_audits table...
âš  Warning: Could not create index idx_compliance_audits_content: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_compliance_audits_content
                    ON cmis.compliance_audits (content_item_id)
                )
âš  Warning: Could not create index idx_compliance_audits_status: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_compliance_audits_status
                    ON cmis.compliance_audits (status, created_at DESC)
                )
Creating indexes for activity_logs table...
âš  Warning: Could not create index idx_audit_user_date: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_audit_user_date
                    ON cmis_audit.activity_logs (user_id, created_at DESC)
                )
âš  Warning: Could not create index idx_audit_action: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_audit_action
                    ON cmis_audit.activity_logs (action, created_at DESC)
                )
âš  Warning: Could not create index idx_audit_model: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_audit_model
                    ON cmis_audit.activity_logs (model_type, model_id)
                )
Creating indexes for personal_access_tokens table...
âš  Warning: Could not create index idx_tokens_tokenable: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_tokens_tokenable
                    ON personal_access_tokens (tokenable_type, tokenable_id)
                )
âš  Warning: Could not create index idx_tokens_created: SQLSTATE[25P02]: In failed sql transaction: 7 ERROR:  current transaction is aborted, commands ignored until end of transaction block (Connection: pgsql, SQL: 
                    CREATE INDEX IF NOT EXISTS idx_tokens_created
                    ON personal_access_tokens (created_at DESC)
                )

âœ“ All performance indexes created successfully!
âœ“ Query performance should be significantly improved


ðŸ“Š Adding foreign key constraints for user reference columns...

âš ï¸  Could not add FK fk_user_permissions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_user_activities_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_user_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_scheduled_social_posts_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_security_context_audit_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_audience_templates_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_campaign_context_links_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_campaigns_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_integrations_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_roles_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_campaign_context_links_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_integrations_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_team_invitations_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...
âš ï¸  Could not add FK fk_user_orgs_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint matching given keys fo...

âœ… Foreign key migration complete!
   Added: 0
   Skipped: 15

âœ“ Fixed performance_metrics constraints
âœ“ Notifications table created with RLS policies

ðŸ“Š Creating foreign keys directly...

âš ï¸  Could not add FK fk_user_permissions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_user_activities_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_user_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_sessions_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_scheduled_social_posts_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_security_context_audit_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_notifications_user: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_audience_templates_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_campaign_context_links_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_campaigns_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_integrations_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_roles_created_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_campaign_context_links_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_integrations_updated_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_team_invitations_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âš ï¸  Could not add FK fk_user_orgs_invited_by: SQLSTATE[42830]: Invalid foreign key: 7 ERROR:  there is no unique constraint ma...
âœ“ Added FK: fk_notifications_org on cmis.notifications.org_id -> cmis.orgs.org_id

âœ… Foreign key creation complete!
   Added: 1
   Skipped: 16

âœ“ Added updated_at to cmis.orgs
âœ“ Added created_at to cmis.user_orgs
âœ“ Added updated_at to cmis.user_orgs
âœ“ Added created_at to cmis.org_markets
âœ“ Added updated_at to cmis.org_markets
âœ“ Added updated_at to cmis.ad_campaigns
âœ“ Added updated_at to cmis.ad_metrics
âœ“ Added updated_at to cmis.ai_actions
âœ“ Added updated_at to cmis.ai_generated_campaigns
âœ“ Added updated_at to cmis.ai_models
âœ“ Added updated_at to cmis.cognitive_tracker_template
âœ“ Added updated_at to cmis.cognitive_trends
âœ“ Added updated_at to cmis.compliance_audits
âœ“ Added updated_at to cmis.content_plans
âœ“ Added updated_at to cmis.contexts
âœ“ Added updated_at to cmis.contexts_base
âœ“ Added updated_at to cmis.copy_components
âœ“ Added updated_at to cmis.creative_assets
âœ“ Added updated_at to cmis.creative_briefs
âœ“ Added updated_at to cmis.experiments
âœ“ Added updated_at to cmis.export_bundles
âœ“ Added updated_at to cmis.field_definitions
âœ“ Added updated_at to cmis.field_values
âœ“ Added updated_at to cmis.job_batches
âœ“ Added updated_at to cmis.jobs
âœ“ Added updated_at to cmis.meta_documentation
âœ“ Added updated_at to cmis.meta_field_dictionary
âœ“ Added updated_at to cmis.meta_function_descriptions
âœ“ Added updated_at to cmis.offerings_full_details
âœ“ Added updated_at to cmis.offerings_old
âœ“ Added updated_at to cmis.password_reset_tokens
âœ“ Added updated_at to cmis.predictive_visual_engine
âœ“ Added updated_at to cmis.reference_entities
âœ“ Added updated_at to cmis.roles
âœ“ Added updated_at to cmis.security_context_audit
âœ“ Added updated_at to cmis.social_post_metrics
âœ“ Added updated_at to cmis.social_posts
âœ“ Added updated_at to cmis.team_account_access
âœ“ Added updated_at to cmis.user_activities
âœ“ Added updated_at to cmis.user_sessions
âœ“ Added updated_at to cmis.value_contexts
âœ“ Added created_at to cmis.permissions
âœ“ Added updated_at to cmis.permissions
âœ“ Added created_at to cmis.role_permissions
âœ“ Added updated_at to cmis.role_permissions
âœ“ Added created_at to cmis.user_permissions
âœ“ Added updated_at to cmis.user_permissions
âœ“ Added created_at to cmis.social_accounts
âœ“ Added created_at to cmis.team_invitations
âœ“ Added updated_at to cmis.team_invitations
âœ“ Added created_at to cmis.sessions
âœ“ Added updated_at to cmis.sessions
âœ“ Added current_org_id to cmis.users
âœ“ Added status to cmis.users
âœ“ Added id column to cmis.notifications
âœ“ Created transaction context functions
âœ“ Added notifiable_type and notifiable_id to cmis.notifications
âœ“ Added post_id to cmis.scheduled_social_posts
âœ“ Added metadata to cmis.users
âœ“ Added primary key to cmis.users(user_id)
âœ“ Added account_username to cmis.integrations
âœ“ Added account_name to cmis.integrations
âœ“ Added refresh_token to cmis.integrations
âœ“ Added token_expires_at to cmis.integrations
âœ“ Added expires_at to cmis.integrations
âœ“ Added status to cmis.integrations
âœ“ Added metadata to cmis.integrations
âœ“ Added scopes to cmis.integrations
âœ“ Added user_org_id to cmis.user_orgs
âœ“ Added invited_at to cmis.user_orgs
âœ“ Made campaign_external_id nullable in cmis.ad_campaigns
âœ“ Created table: cmis.team_members
âœ“ Created table: cmis.leads
âœ“ Created table: cmis.webhooks
âœ“ Created table: cmis.contacts
âœ“ Created table: cmis.knowledge_index
âœ“ Created table: cmis.subscriptions
âœ“ Created table: cmis.api_logs
âœ“ Created table: cmis.content_plan_items
âœ“ Created table: cmis.offerings
âœ“ Created table: cmis.content
âœ“ Created table: cmis.platform_connections
âœ“ Created table: cmis.assets
âœ“ Created table: cmis.invoices
âœ“ Created table: cmis.audiences
âœ“ Created table: cmis.templates
âœ“ Created table: cmis.posts
âœ“ Created table: cmis.custom_fields
âœ“ Created table: cmis.comments
âœ“ Created table: cmis.budgets
âœ“ Created table: cmis.audit_logs

âœ… Migration complete! Created 20 missing tables.
âœ“ Added code column to public.markets
âœ“ Updated cmis.markets view to include code column
âœ“ Added name column to cmis.permissions

âœ… Added missing columns successfully!
âœ“ Created table: cmis.audience_segments
âœ“ Created table: cmis.analytics_snapshots
âœ“ Created table: cmis.analytics_reports
âœ“ Created table: cmis.activities
âœ“ Created table: cmis.workflows
âœ“ Created table: cmis.tags
âœ“ Created table: cmis.notification_preferences
âœ“ Created table: cmis.metrics
âœ“ Created table: cmis.content_media
âœ“ Created table: cmis.campaign_budgets

âœ… Migration complete! Created 10 additional tables.
âœ“ Added team_member_id to team_members
âœ“ Added updated_at to api_logs
âœ“ Added name to markets
âœ“ Added knowledge_id to knowledge_index
âœ“ Added platform to posts
âœ“ Added commentable_type to comments
âœ“ Added commentable_id to comments
âœ“ Added total_amount to budgets
âœ“ Added title to knowledge_index
âœ“ Added score to leads
âœ“ Added log_id to audit_logs

âœ… All column fixes applied successfully!
âœ“ Created table: cmis.activity_logs
âœ“ Created table: cmis.settings
âœ“ Created table: cmis.schedules
âœ“ Created table: cmis.campaign_analytics
âœ“ Created table: cmis.social_posts_v2
âœ“ Created table: cmis.social_accounts_v2
âœ“ Created table: cmis.content_plans_v2
âœ“ Created table: cmis.scheduled_social_posts_v2
âœ“ Created table: cmis.embeddings_cache
âœ“ Created table: cmis.campaign_metrics

âœ… Migration complete! Created 10 additional tables.
âœ“ Made event_type nullable in webhooks
âœ“ Made plan_id nullable in content_plan_items
âœ“ Made role_name nullable in roles
âœ“ Made permission_code nullable in permissions
âœ“ Made brief_data nullable in creative_briefs

âœ… All NULL constraint fixes applied!
âœ“ Added usage_count to assets
âœ“ Added report_name to analytics_reports
âœ“ Added activity_id to activity_logs
