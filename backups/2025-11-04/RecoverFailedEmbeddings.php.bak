<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class RecoverFailedEmbeddings extends Command
{
    protected $signature = 'cmis:recover-failed-embeddings 
                            {--log=/httpdocs/storage/logs/laravel.log : Path to the Laravel log file}
                            {--batch=20 : Number of entries to process per batch}';

    protected $description = 'Analyze laravel.log and recover failed CMIS embeddings with automatic feedback learning';

    private int $successCount = 0;
    private int $failureCount = 0;

    public function handle()
    {
        $logPath = $this->option('log');
        $batchSize = (int) $this->option('batch');

        if (!file_exists($logPath)) {
            $this->error("Log file not found: {$logPath}");
            return Command::FAILURE;
        }

        $this->info("ğŸ” Scanning log file: {$logPath}");
        $pattern = '/Connection: pgsql, SQL: update "cmis_knowledge"."index".*knowledge_id\s*=\s*\'([\w-]+)\'.*topic_embedding\s*=\s*\[(.*?)\]/i';

        $file = new \SplFileObject($logPath, 'r');
        $file->seek(PHP_INT_MAX);
        $lineCount = $file->key();

        $batch = [];

        for ($i = $lineCount; $i >= 0; $i--) {
            $file->seek($i);
            $line = $file->current();

            if (preg_match($pattern, $line, $matches)) {
                $batch[] = [
                    'knowledge_id' => $matches[1],
                    'embedding' => '[' . trim($matches[2]) . ']'
                ];

                if (count($batch) >= $batchSize) {
                    $this->processBatch($batch);
                    $batch = [];
                }
            }
        }

        if (count($batch) > 0) {
            $this->processBatch($batch);
        }

        $this->registerKnowledgeFeedback();

        $this->info("âœ… Completed recovery process. Success: {$this->successCount}, Failures: {$this->failureCount}");
        return Command::SUCCESS;
    }

    private function processBatch(array $batch)
    {
        foreach ($batch as $item) {
            try {
                $exists = DB::selectOne(
                    'SELECT topic_embedding FROM cmis_knowledge.index WHERE knowledge_id = $1',
                    [$item['knowledge_id']]
                );

                if ($exists && ($exists->topic_embedding === null || $exists->topic_embedding === '[]')) {
                    DB::update(
                        'UPDATE cmis_knowledge.index SET topic_embedding = $1, updated_at = NOW() WHERE knowledge_id = $2',
                        [$item['embedding'], $item['knowledge_id']]
                    );

                    DB::insert(
                        'INSERT INTO cmis_dev.dev_logs (event, details, created_at)
                         VALUES ($1, $2::jsonb, NOW())',
                        [
                            'embedding_recovered',
                            json_encode(['knowledge_id' => $item['knowledge_id']])
                        ]
                    );

                    $this->line("âœ… Recovered embedding for {$item['knowledge_id']}");
                    $this->successCount++;
                } else {
                    $this->line("âš ï¸ Skipped (already has embedding): {$item['knowledge_id']}");
                }

            } catch (\Exception $e) {
                $this->failureCount++;
                Log::error("Embedding recovery failed for {$item['knowledge_id']}: " . $e->getMessage());

                DB::insert(
                    'INSERT INTO cmis_dev.dev_logs (event, details, created_at)
                     VALUES ($1, $2::jsonb, NOW())',
                    [
                        'embedding_recovery_failed',
                        json_encode([
                            'knowledge_id' => $item['knowledge_id'],
                            'error' => $e->getMessage()
                        ])
                    ]
                );
            }
        }
    }

    private function registerKnowledgeFeedback()
    {
        $summary = "Embedding recovery completed with {$this->successCount} successes and {$this->failureCount} failures.";

        try {
            if ($this->successCount > 0) {
                DB::select(
                    'SELECT cmis_knowledge.register_knowledge($1, $2, $3, $4, 2, ARRAY[$5,$6])',
                    [
                        'system',
                        'dev',
                        'Embedding Recovery Success',
                        "âœ… {$summary}",
                        'embedding',
                        'automation'
                    ]
                );
            }

            if ($this->failureCount > 0) {
                DB::select(
                    'SELECT cmis_knowledge.register_knowledge($1, $2, $3, $4, 2, ARRAY[$5,$6,$7])',
                    [
                        'system',
                        'dev',
                        'Embedding Recovery Failures',
                        "âŒ {$summary}\nCheck dev_logs for details.",
                        'embedding',
                        'postmortem',
                        'error'
                    ]
                );
            }

            $this->info("ğŸ’¡ Knowledge feedback recorded successfully.");

        } catch (\Exception $e) {
            $this->error("âš ï¸ Failed to record feedback knowledge: " . $e->getMessage());
        }
    }
}
